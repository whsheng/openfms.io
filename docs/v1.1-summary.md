# OpenFMS v1.1 稳定版开发总结

> 文档创建时间: 2026-02-04
> 版本: v1.1.0-stable

---

## 一、版本概述

v1.1 稳定版在 v1.0 基础版之上，完成了四个核心功能模块：

1. **地图集成与实时监控** - Mapbox GL JS 地图引擎
2. **电子围栏功能** - 圆形/多边形围栏，进出检测
3. **报警中心** - 实时报警、规则配置、统计分析
4. **RBAC 用户权限系统** - 角色管理、权限控制

---

## 二、功能模块详情

### 2.1 地图集成与实时监控

#### 已实现功能
- [x] Mapbox GL JS 地图引擎集成
- [x] 车辆位置标记（自定义图标 + 方向指示）
- [x] 车辆平滑移动动画
- [x] 点击车辆弹出信息卡片
- [x] 地图控件（缩放、全屏、定位、比例尺）
- [x] 矢量/卫星地图切换
- [x] 交通图层显示
- [x] 车辆状态筛选（全部/行驶中/静止/离线）
- [x] WebSocket 实时位置推送

#### 技术实现
- **地图引擎**: Mapbox GL JS v3.x
- **实时推送**: WebSocket (gorilla/websocket)
- **数据流**: 设备 → 网关 → NATS → API WebSocket → 前端

#### 相关文件
```
web/src/components/MapboxMap/
├── useMapbox.ts          # Mapbox 初始化 Hook
├── VehicleMarker.tsx     # 车辆标记组件
└── MapboxMap.tsx         # 主地图组件

web/src/pages/Monitor/
├── MonitorPage.tsx       # 监控主页面
└── monitor.module.css    # 样式

api/internal/handler/ws.go    # WebSocket 处理器
web/src/hooks/useLocationStream.ts  # 位置流 Hook
```

---

### 2.2 电子围栏功能

#### 已实现功能
- [x] 圆形围栏创建（地图点击选中心点 + 半径）
- [x] 多边形围栏创建（地图点击绘制顶点）
- [x] 围栏 CRUD 操作
- [x] 设备绑定/解绑围栏
- [x] 实时进出围栏检测
- [x] 围栏事件记录
- [x] 围栏报警触发

#### 技术实现
- **检测算法**: Haversine 公式（圆形）、射线法（多边形）
- **检测位置**: API 服务实时计算
- **存储**: PostgreSQL + PostGIS

#### 相关文件
```
database/init/02_geofence.sql     # 围栏数据库表

api/internal/model/geofence.go    # 数据模型
api/internal/service/geofence.go  # 围栏业务逻辑
api/internal/service/geofence_checker.go  # 围栏检测服务
api/internal/handler/geofence.go  # API 处理器

web/src/pages/Geofence/
├── GeofenceList.tsx      # 围栏列表
├── GeofenceForm.tsx      # 围栏表单
├── GeofenceMap.tsx       # 地图绘制
├── GeofenceDetail.tsx    # 围栏详情
└── geofence.module.css   # 样式
```

---

### 2.3 报警中心

#### 已实现功能
- [x] 报警类型：围栏进出、超速、离线、低电量、SOS、断电等
- [x] 报警级别：严重、警告、信息
- [x] 报警状态：未读、已读、已处理
- [x] 实时报警接收（WebSocket 推送）
- [x] 报警列表（筛选、分页、批量操作）
- [x] 报警统计（处理率、状态分布、级别分布）
- [x] 报警规则配置
- [x] 声音提醒（严重报警）
- [x] 通知弹窗

#### 技术实现
- **报警检测**: API 服务订阅 NATS 消息
- **超速检测**: 实时计算速度对比限速
- **离线检测**: 定时任务检查设备最后上报时间
- **推送**: WebSocket + 浏览器 Notification

#### 相关文件
```
database/init/03_alarm.sql        # 报警数据库表

api/internal/model/alarm.go       # 数据模型
api/internal/service/alarm.go     # 报警服务
api/internal/handler/alarm.go     # API 处理器

web/src/pages/Alarm/
├── AlarmCenter.tsx       # 报警中心主页面
├── AlarmList.tsx         # 报警列表
├── AlarmStats.tsx        # 报警统计
├── AlarmRules.tsx        # 报警规则
├── alarm.module.css      # 样式
└── index.ts              # 模块导出

web/src/types/alarm.ts    # TypeScript 类型定义
```

---

### 2.4 RBAC 用户权限系统

#### 已实现功能
- [x] 角色管理（CRUD）
- [x] 权限管理（分组展示）
- [x] 用户管理（CRUD、分配角色）
- [x] 权限中间件（RequirePermission、RequireAnyPermission、RequireAllPermissions）
- [x] 超级管理员自动绕过权限检查
- [x] 前端权限控制（菜单显示、按钮控制）

#### 系统角色
| 角色 | 编码 | 权限范围 |
|------|------|----------|
| 超级管理员 | super_admin | 所有权限 |
| 管理员 | admin | 除角色管理外的所有权限 |
| 操作员 | operator | 日常操作权限 |
| 观察员 | viewer | 只读权限 |

#### 权限列表
- 设备管理：device:read, device:create, device:update, device:delete, device:command
- 位置轨迹：position:read
- 电子围栏：geofence:read, geofence:create, geofence:update, geofence:delete
- 报警中心：alarm:read, alarm:resolve, alarm:rule
- 用户管理：user:read, user:create, user:update, user:delete, role:manage
- 系统设置：setting:read, setting:update

#### 相关文件
```
database/init/04_rbac.sql         # RBAC 数据库表

api/internal/model/rbac.go        # 数据模型
api/internal/handler/rbac.go      # API 处理器
api/internal/middleware/rbac.go   # 权限中间件

web/src/pages/Users/
├── UserList.tsx          # 用户列表
├── UserForm.tsx          # 用户表单
├── RoleList.tsx          # 角色列表
├── RoleForm.tsx          # 角色表单
├── user.module.css       # 样式
└── index.ts              # 模块导出

web/src/types/user.ts     # TypeScript 类型定义
```

---

## 三、技术架构

### 3.1 系统架构
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   前端 Web   │────→│   API 服务   │←────│   设备网关   │
│  (React)    │     │   (Go/Gin)  │     │   (Go/Net)  │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        ↓                  ↓                  ↓
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  TimescaleDB │     │    Redis    │     │    NATS     │
│ (PostgreSQL)│     │   (缓存)     │     │  (消息队列)  │
└─────────────┘     └─────────────┘     └─────────────┘
```

### 3.2 数据流

#### 上行（设备 → 平台）
```
设备 → 网关 → 协议解析 → NATS → API 服务 → 数据库/Redis
                              ↓
                         WebSocket 推送
                              ↓
                            前端
```

#### 下行（平台 → 设备）
```
前端 → API 服务 → NATS → 网关 → 协议编码 → 设备
```

---

## 四、项目结构

```
openfms/
├── gateway/              # 设备网关服务 (Go)
│   ├── cmd/gateway/
│   ├── internal/
│   │   ├── adapter/      # 协议适配器 (JT808)
│   │   ├── config/
│   │   ├── protocol/
│   │   └── server/       # TCP 服务器
│   ├── Dockerfile
│   └── go.mod
│
├── api/                  # API 服务 (Go)
│   ├── cmd/api/
│   ├── internal/
│   │   ├── config/
│   │   ├── handler/      # HTTP 处理器
│   │   │   ├── auth.go
│   │   │   ├── device.go
│   │   │   ├── position.go
│   │   │   ├── geofence.go
│   │   │   ├── alarm.go
│   │   │   ├── rbac.go
│   │   │   └── ws.go     # WebSocket
│   │   ├── middleware/   # 中间件
│   │   │   └── rbac.go   # 权限中间件
│   │   ├── model/        # 数据模型
│   │   │   ├── user.go
│   │   │   ├── device.go
│   │   │   ├── geofence.go
│   │   │   ├── alarm.go
│   │   │   └── rbac.go
│   │   ├── server/       # HTTP 服务器
│   │   └── service/      # 业务逻辑
│   │       ├── auth.go
│   │       ├── device.go
│   │       ├── position.go
│   │       ├── geofence.go
│   │       ├── geofence_checker.go
│   │       └── alarm.go
│   ├── Dockerfile
│   └── go.mod
│
├── web/                  # 前端应用 (React)
│   ├── src/
│   │   ├── components/   # 公共组件
│   │   │   ├── Layout.jsx
│   │   │   └── MapboxMap/
│   │   ├── pages/        # 页面
│   │   │   ├── Dashboard/
│   │   │   ├── Login/
│   │   │   ├── Monitor/
│   │   │   ├── Devices/
│   │   │   ├── Geofence/
│   │   │   ├── Alarm/
│   │   │   ├── Users/
│   │   │   ├── History/
│   │   │   └── Settings/
│   │   ├── hooks/        # React Hooks
│   │   │   ├── useWebSocket.ts
│   │   │   └── useLocationStream.ts
│   │   ├── services/     # API 服务
│   │   │   └── api.js
│   │   ├── stores/       # 状态管理
│   │   ├── types/        # TypeScript 类型
│   │   │   ├── alarm.ts
│   │   │   └── user.ts
│   │   ├── App.jsx
│   │   └── main.jsx
│   ├── Dockerfile
│   ├── package.json
│   └── vite.config.js
│
├── database/
│   └── init/             # 数据库初始化脚本
│       ├── 01_init.sql   # 基础表
│       ├── 02_geofence.sql
│       ├── 03_alarm.sql
│       └── 04_rbac.sql
│
├── docs/                 # 文档
│   ├── deployment.md
│   ├── api.md
│   ├── protocol.md
│   └── v1.1-summary.md   # 本文档
│
├── docker-compose.yml
├── Makefile
├── README.md
├── ROADMAP.md
└── openfms-think.md
```

---

## 五、API 接口列表

### 认证
- `POST /api/v1/auth/login` - 登录
- `GET /api/v1/auth/me` - 获取当前用户

### 设备
- `GET /api/v1/devices` - 设备列表
- `POST /api/v1/devices` - 创建设备
- `GET /api/v1/devices/:id` - 设备详情
- `PUT /api/v1/devices/:id` - 更新设备
- `DELETE /api/v1/devices/:id` - 删除设备
- `GET /api/v1/devices/:id/shadow` - 设备影子
- `POST /api/v1/devices/:id/commands` - 发送指令

### 位置
- `GET /api/v1/positions/latest` - 所有设备最新位置
- `GET /api/v1/devices/:id/positions` - 历史轨迹
- `GET /api/v1/devices/:id/positions/latest` - 最新位置

### 电子围栏
- `GET /api/v1/geofences` - 围栏列表
- `POST /api/v1/geofences` - 创建围栏
- `GET /api/v1/geofences/:id` - 围栏详情
- `PUT /api/v1/geofences/:id` - 更新围栏
- `DELETE /api/v1/geofences/:id` - 删除围栏
- `POST /api/v1/geofences/:id/bind` - 绑定设备
- `POST /api/v1/geofences/:id/unbind` - 解绑设备
- `GET /api/v1/geofences/:id/devices` - 绑定设备列表
- `GET /api/v1/geofences/:id/events` - 围栏事件

### 报警
- `GET /api/v1/alarms` - 报警列表
- `GET /api/v1/alarms/stats` - 报警统计
- `GET /api/v1/alarms/types` - 报警类型
- `GET /api/v1/alarms/:id` - 报警详情
- `POST /api/v1/alarms/:id/read` - 标记已读
- `POST /api/v1/alarms/:id/resolve` - 处理报警
- `POST /api/v1/alarms/batch-read` - 批量已读
- `POST /api/v1/alarms/batch-resolve` - 批量处理
- `GET /api/v1/alarms/rules` - 报警规则列表
- `PUT /api/v1/alarms/rules/:id` - 更新规则

### 用户管理
- `GET /api/v1/users` - 用户列表
- `POST /api/v1/users` - 创建用户
- `GET /api/v1/users/:id` - 用户详情
- `PUT /api/v1/users/:id` - 更新用户
- `DELETE /api/v1/users/:id` - 删除用户
- `POST /api/v1/users/:id/role` - 分配角色
- `GET /api/v1/users/:id/permissions` - 用户权限

### 角色管理
- `GET /api/v1/roles` - 角色列表
- `POST /api/v1/roles` - 创建角色
- `GET /api/v1/roles/:id` - 角色详情
- `PUT /api/v1/roles/:id` - 更新角色
- `DELETE /api/v1/roles/:id` - 删除角色
- `GET /api/v1/roles/:id/permissions` - 角色权限

### 权限管理
- `GET /api/v1/permissions` - 权限列表
- `GET /api/v1/permissions/groups` - 权限分组

### WebSocket
- `ws://host/ws/location` - 实时位置流
- `ws://host/ws/stats` - WebSocket 统计

---

## 六、部署说明

### 环境要求
- Docker 20.10+
- Docker Compose 2.0+
- 2核CPU / 4GB内存 / 50GB存储

### 一键部署
```bash
# 克隆仓库
git clone https://github.com/your-org/openfms.git
cd openfms

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f
```

### 访问服务
| 服务 | 地址 |
|------|------|
| Web界面 | http://localhost |
| API服务 | http://localhost:3000 |
| 网关TCP | localhost:8080 |
| 网关HTTP | http://localhost:8081 |
| NATS监控 | http://localhost:8222 |

### 默认账号
- 用户名: `admin`
- 密码: `admin`
- 角色: 管理员

---

## 七、已知问题与注意事项

### 需要配置 Mapbox Token
编辑 `web/src/components/MapboxMap/useMapbox.ts`，将 `YOUR_MAPBOX_TOKEN` 替换为实际的 Mapbox public token。

获取方式：
1. 访问 https://www.mapbox.com/
2. 注册账号
3. 进入 Account → Access tokens
4. 复制 Default public token

### 数据库初始化
首次启动时会自动执行数据库迁移，创建所有表结构和默认数据。

### 权限说明
- 超级管理员拥有所有权限，不受权限中间件限制
- 系统内置角色（super_admin, admin, operator, viewer）不可删除
- 新创建的用户默认无权限，需要分配角色

---

## 八、下一步计划 (v1.2 增强版)

根据 ROADMAP.md，v1.2 计划开发：

1. **视频服务 (JT1078)**
   - JT1078 协议支持
   - ZLMediaKit/SRS 流媒体服务集成
   - 实时视频播放
   - 历史视频回放

2. **报表统计**
   - 里程报表
   - 停车报表
   - 速度分析图表
   - 数据导出 Excel/PDF

3. **多协议适配**
   - GT06 协议
   - Wialon IPS 协议
   - Traccar/OsmAnd 协议

4. **系统监控**
   - Prometheus 监控
   - Grafana 仪表盘
   - 日志聚合 (ELK/Loki)

---

## 九、贡献者

- 开发团队: OpenFMS Team
- 文档维护: AI Assistant

---

## 十、许可证

[MIT](LICENSE) © OpenFMS Team
